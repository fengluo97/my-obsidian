---
aliases: 
tags:
  - 后端
  - JVM
created: "{{date}} {{time}}"
---


平台无关性 - 虚拟机
语言无关性 - 字节码格式

> [!info] 其他语言可以通过 其对应的编译器编译为字节码，即 class 文件

# 一、Class 类文件结构
Class 文件是一组以字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑排列在文件之中，中间没有任何分隔符。

|      类型      |               名称               |          数量          |
|:--------------:|:--------------------------------:|:----------------------:|
|       u4       |            magic 魔数            |           1            |
|       u2       |      minor_version 次版本号      |           1            |
|       u2       |    major_version     主版本号    |           1            |
|       u2       | constant_pool_count 常量池计数器 |           1            |
|    cp_info     |     constant_pool    常量池      | constant_pool_count -1 |
|       u2       |   access_flags       访问标志    |           1            |
|       u2       |            this_class   类索引         |           1            |
|       u2       |           super_class      父类索引      |           1            |
|       u2       |         interfaces_count      接口索引计数器   |           1            |
|       u2       |            interfaces       接口索引     |    interfaces_count    |
|       u2       |           fields_count  字段集合计数器         |           1            |
|   field_info   |              fields         字段集合     |      fields_count      |
|       u2       |          methods_count    方法集合计数器       |           1            |
|  method_info   |             methods           方法集合   |     methods_count      |
|       u2       |         attributes_count      属性集合计数器   |           1            |
| attribute_info |            attributes       属性集合     |    attributes_count    |

### 1、魔数与 Class 文件版本

魔数 MagicNumber：不仅是 Class 文件，很多文件格式标准中都有使用魔数来进行识别的习惯。
使用魔数而不是扩展名来进行识别主要是基于安全考虑，因为文件扩展名可以随意改动。Class 文件的头4个字节被用来存放魔数，Java Class 文件的魔数名为 CAFEBABE。

紧接着魔数的后四个字节为 Class 文件的版本号，第5个和第6个字节为次版本号，第7个和第8个字节为主版本号。

### 2、常量池
常量池可以比喻为 Class 文件的资源仓库，因为常量池中常量的数量是不确定的，所以在常量池的入口放置了一个常量池计数器，是唯一一个从 1 开始计数的（考虑到将来的特殊扩展，不引用任何一个常量项目）

主要用来存放两大类常量：字面量和符号引用。
- 字面量
	- 字符串
	- 被声明为 final 的常量值
- 符号引用
	- 被模块导出或开放的包
	- 类和接口的全限定名
	- 字段的名称和描述符
	- 方法的名称和描述符
	- 方法句柄和方法类型
	- 动态调用点和动态常量

### 3、访问标志
常量池之后的2个字节代表访问标志，用于标识一些类或者接口层次的访问信息，包括：
- 这个 Class 是类还是接口
- 是否为 public 类型
- 是否为 abstract 类型
- 类是否被声明为 final


### 4、类索引、父类索引与接口索引集合

Class 文件用这三项数据确定这个类的继承关系。
- 类索引：确定类的全限定名
- 父类索引：确定父类的全限定名
- 接口索引：确定这个类实现了哪些接口

类可以继承一个父类，实现多个接口。
接口可以继承多个接口。

### 5、字段表集合

字段表用于描述接口或者类中声明的变量。

一般来说，一个字段会包含以下信息：
- 作用域：public、protected、private 修饰符
- 实例变量还是类变量：static 修饰符
- 可变性：final 修饰符
- 并发可见性：volatile 修饰符
- 是否可被序列化：transient 修饰符
- 字段的数据类型：基本类型、对象、数组
- 字段名称

上述，各个修饰符都是布尔值，可以使用标志位来表示，但是字段的数据类型是不固定的，只能引用常量池中的常量来描述。


- 全限定名：类的全路径名
- 简单名称：没有类型和参数修饰的方法或字段的名称
- 描述符：根据描述符规则来描述字段的数据类型、方法的参数列表和返回值类型，规则如下：
	- B，基本类型 byte
	- C，基本类型 char
	- D，基本类型 dubbo
	- F，基本类型 float
	- I，基本类型 int
	- J，基本类型 long
	- S，基本类型 short
	- Z，基本类型 boolean
	- V，特殊类型 void
	- L，对象类型
	- \[，数组

字段表的结构包含了：
- access_flag，访问标志
- name_index，简单名称
- descriptor_index，描述符
- attributes_count，属性计数器
- attributes，属性集合

字段表中不会列出父类或者父接口中继承而来的字段，但有可能出现由编译器自动添加的字段。在Java中字段是无法重载的，也就是说两个字段的数据类型和修饰符不管是否相同，都必须使用不一样的名称，但是在 Class 文件格式中，只要两个字段的描述符不是完全相同，就是合法的。
### 6、方法表集合
方法表和字段表几乎一致，除了 volatile 和 transient 不能修饰方法导致少了两种类型的访问标志之外，还增加了 synchronized、native、strictfp、abstract 访问标志。

方法的定义可以通过访问标志、名称索引、描述符索引来表达，**方法中的代码经过 Javac 编译成字节码指令后，存放在方法属性表集合中一个名为 ”Code“ 的属性里面**。

方法表中不会出现没有被重写的父类方法信息，但有可能出现由编译器自动添加的方法，最常见的比如 类构造器 \<clinit\> 和 实例构造器 \<init\>，**类构造器为静态变量服务，实例构造器为成员变量服务。**

在 Java 中，重载一个方法，必须要有一个不同于原方法的特征签名，包含了方法名称、参数数量、参数顺序以及参数类型。而字节码的特征签名还包含了方法返回值类型以及受查异常表，所以如果两个方法只有返回值类型不同，在 Class 文件格式中是合法的。

### 7、 属性表集合
属性表集合在上文中已经出现多次了，Class 文件、字段表、方法表都可以携带自己的属性表集合，以描述某些场景专有的信息。

属性表的限制稍微宽松一些，不再要求各个属性表具有严格顺序，并且只要不与现有属性名重复，任何编译器都可以向属性表中写入自定义的属性信息，极大的提高了 Class 文件的扩展性。

#### Code 属性
Java 程序方法体里面的代码经过 Javac 编译器处理之后，最终编程字节码指令存储在 Code 属性内，接口方法和抽象类中的抽象方法不存在 Code 属性。

> [!info] try-catch-finally 按顺序执行
> 如果 try 或者 catch 中有 return，在 return 之前会走 finally，return 时的 returnValue 会在局部变量表中保存一个副本，走完 finally 之后会将这个副本重新读到操作数栈顶，并返回。如此以来，如果 finally 操作的是基本类型和字符串类型，returnValue 不会改变，因为基本类型为传值，String 是不可变的，只有引用类型会被改变。
> 如果 finally 中有 return，那么会直接 return finally 的 returnValue。

```java
private static int test1() {  
	int x;  
	try {  
		x = 1;  
		// throw new RuntimeException();  
		return x;  
	} catch (Exception e) {  
		x = 2;  
		return x;  
	} finally {  
		x = 3;  
	}  
	// return 之前会将返回值临时复制一份到局部变量中，然后去执行 finally，如果 finally 中没有 return，则读取副本返回  
	// 没抛异常 打印 1，抛异常 打印 2
}
```


#### 其他属性
其他属性还包括了 Exception 属性（描述方法可能抛出的受检查异常）、LineNumberTable 属性（描述 Java 源码行号和字节码行号之间的对应关系）等几十项属性。

# 二、字节码指令集
Java 虚拟机的指令由一个字节长度的、代表着某种特定操作含义的数字（操作码）以及跟随




周志明老师 尽可能使用通俗易懂的描述方式来讲解JVM，但是也导致了文字繁多的麻烦，感觉有些难懂的地方描述较少，简单的地方又过于讲解